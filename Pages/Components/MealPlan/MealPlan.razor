@page "/MealPlan"
@using NutrifoodsFrontend.Data.Dto
@using NutrifoodsFrontend.Data.State
@using NutrifoodsFrontend.Services
@using NutrifoodsFrontend.UtilsFolder.Enums
@inject AuthenticationStateProvider AuthState
@inject UserEnergyState UserEnergyState
@inject IDailyMealPlanService MealPlanService
@inject ISnackbar Snackbar

@if (mealPlanResponse == null)
{
    <MudContainer MaxWidth="MaxWidth.Small">
        <div class="d-flex justify-center align-content-center mt-10">
            <MudProgressCircular Class="mr-2" Color="Color.Primary" Indeterminate="true" />
            <MudText Typo="Typo.h6">Estamos generando tu Plan Alimentario</MudText> 
        </div> 
    </MudContainer>
    
    
    <!-- if(UserHasNoMetrics) -->

}
else
{
    @if (!mealPlanResponse.IsSuccessStatusCode)
    {
        <MudText>Error @mealPlanResponse.ReasonPhrase</MudText>
    }
    else
    {
        
        <!-- MealPlan recibe una Regimen alimentario -->
        <MudContainer MaxWidth="MaxWidth.Small">

            <!-- Input: Cantidad de calorías | Destino: Componente hijo CaloriesTotal -->
            <CaloriesTotal Macronutrients="TotalMacronutrients()"/>
            @foreach(var menu in MealMenus)
            {
                <div class="mt-3">
                    <!-- Input: Comida del día | Destino: Componente hijo MealComponent -->
                    <MealComponent MenuRecipes=@menu.MenuRecipes />
                </div>
            }
            <AuthorizeView>
                <Authorized>
                    <div class="d-flex justify-space-between mt-3 mb-3">
                        <MudButton Style="width: 175px; height: 50px;"
                                               Class="pa-3 rounded-pill"
                                               Size="Size.Large"
                                               Variant="Variant.Filled"
                                               Color="Color.Primary"
                                                @onclick="@(() => Snackbar.Add("Plan alimentario confirmado",
                                                Severity.Success, config => { config.HideIcon = true;}))">
                                                                
                                                Confirmar
                        </MudButton>
                        <MudButton Style="width: 175px; height: 50px;"
                                               Class="pa-3 rounded-pill"
                                               Size="Size.Large"
                                               Variant="Variant.Filled"
                                               Color="Color.Primary"
                                               ButtonType="ButtonType.Submit"
                                               OnClick="OnInitializedAsync">
                                               Regenerar
                        </MudButton>
                    </div>
                </Authorized>
                <NotAuthorized>
                    <div class="d-flex justify-end mt-3 mb-3">
                        <MudButton Style="width: 175px; height: 50px;"
                                               Class="pa-3 rounded-pill"
                                               Size="Size.Large"
                                               Variant="Variant.Filled"
                                               Color="Color.Primary"
                                               ButtonType="ButtonType.Submit"
                                               OnClick="OnInitializedAsync">
                                               Regenerar
                        </MudButton>
                    </div>
                </NotAuthorized>
            </AuthorizeView>
            
        </MudContainer>        
    }
}



@code {
    private HttpResponseMessage? mealPlanResponse { get; set; }
    private DailyMealPlanDto? mealPlan { get; set; }
    private List<DailyMenuDto>? MealMenus { get; set; }
    [Parameter] public int GuestEnergy { get; set; }
    
    protected override async Task OnInitializedAsync()
    {
        var state = await AuthState.GetAuthenticationStateAsync();
        var isAuthenticated = state.User.Identity is {IsAuthenticated: true };

        if(isAuthenticated)
        {
            mealPlanResponse = await MealPlanService.GenerateDailyMealPlan(1900, Satiety.Normal, Satiety.Filling, Satiety.Filling);
            mealPlan = mealPlanResponse.Content.ReadFromJsonAsync<DailyMealPlanDto?>().Result;
            MealMenus = mealPlan?.DailyMenus.ToList();

        }
        else {
            var guestUserEnergy = UserEnergyState.Property;
            mealPlanResponse = await MealPlanService.GenerateDailyMealPlan(guestUserEnergy, Satiety.Normal, Satiety.Filling, Satiety.Filling);
            if (mealPlanResponse != null) mealPlan = mealPlanResponse.Content.ReadFromJsonAsync<DailyMealPlanDto>().Result;
            MealMenus = mealPlan?.DailyMenus.ToList();
        }
        
        await base.OnInitializedAsync();
    }


    private int CalculateEnergy() => Convert.ToInt32(mealPlan.DailyMenus.Sum(e => e.EnergyTotal));
   
    private int CalculateCarbs() => Convert.ToInt32(mealPlan.DailyMenus.Sum(e => e.CarbohydratesTotal));
    
    private int CalculateLipids() => Convert.ToInt32(mealPlan.DailyMenus.Sum(e => e.LipidsTotal));

    private int CalculateProteins() => Convert.ToInt32(mealPlan.DailyMenus.Sum(e => e.ProteinsTotal));
    
    
    private Dictionary<string, int> TotalMacronutrients()
    {
        var nutrients = new Dictionary<string, int>
        {
            { "Energy", CalculateEnergy() },
            { "Carbohydrates", CalculateCarbs() },
            { "Lipids", CalculateLipids() },
            { "Proteins", CalculateProteins() }
        };
        return nutrients;
    }
   
}